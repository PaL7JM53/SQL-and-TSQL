--expection report view

USE [OpsTech_DB]
GO

/****** Object:  View [HIERARCHY].[REPORT]    Script Date: 9/24/2025 10:57:43 AM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


--ALTER VIEW [HIERARCHY].[REPORT]  AS
   
-- Created by Kevin Fox on June 2025
with 
RootFloc as(select fl.Functional_Location RootFloc, flcc.Tech_Object_Type, flcc.Api_No10
FROM [OXY#redacted].[OPS#redacted].[Functional_Location] AS FL
INNER JOIN [OXY#redacted].[OPS#redacted].[Functional_Location_Class_Characteristics] AS FLCC
    ON FL.functional_location = FLCC.functional_location
WHERE FLCC.Tech_Object_Type in ('FCLTY', 'WELLG')
    AND FLCC.Country = 'US'
    AND FL.Tech_Object_Type in ('FCLTY', 'WELLG')
    AND FL.Floc_User_Status not in ('DECM','PLAN','SOLD','PLAB')
and FL.Operating_Segment_Level1 not like 'GULF%'
)

,MinFac as (SELECT [RootFloc]
       ,[Depth]
	   ,min(Distance) MinDistance
	   ,ConnectionType	
	   ,Direction
  FROM [OpsTech_DB].[HIERARCHY].[FacilityHierarchy]

group by RootFloc, Depth,ConnectionType,Direction)
-----------------------------------------
,Oil_Fac_Lvl1 as (
select [FacilityHierarchy].RootFloc
,Floc as Oil_Facility
,Distance
FROM [OpsTech_DB].[HIERARCHY].[FacilityHierarchy]
inner join MinFac on MinFac.RootFloc = FacilityHierarchy.RootFloc
				and	minfac.Depth = FacilityHierarchy.Depth
				and MinFac.MinDistance = FacilityHierarchy.Distance
				and MinFac.ConnectionType = FacilityHierarchy.ConnectionType
				and MinFac.Direction = FacilityHierarchy.Direction
where   [FacilityHierarchy].Direction = 'downstream'
and [FacilityHierarchy].depth = 1
and [FacilityHierarchy].ConnectionType = 'oil')

-----------------------------------------
,Gas_Fac_Lvl1 as (
select [FacilityHierarchy].RootFloc
,Floc as Gas_Facility
,Distance
FROM [OpsTech_DB].[HIERARCHY].[FacilityHierarchy]
inner join MinFac on MinFac.RootFloc = FacilityHierarchy.RootFloc
				and	minfac.Depth = FacilityHierarchy.Depth
				and MinFac.MinDistance = FacilityHierarchy.Distance
				and MinFac.ConnectionType = FacilityHierarchy.ConnectionType
				and MinFac.Direction = FacilityHierarchy.Direction
where   [FacilityHierarchy].Direction = 'downstream'
and [FacilityHierarchy].depth = 1
and [FacilityHierarchy].ConnectionType = 'gas')

-----------------------------------------
,Water_Fac_Lvl1 as (
select [FacilityHierarchy].RootFloc
,Floc as Water_Facility
,Distance
FROM [OpsTech_DB].[HIERARCHY].[FacilityHierarchy]
inner join MinFac on MinFac.RootFloc = FacilityHierarchy.RootFloc
				and	minfac.Depth = FacilityHierarchy.Depth
				and MinFac.MinDistance = FacilityHierarchy.Distance
				and MinFac.ConnectionType = FacilityHierarchy.ConnectionType
				and MinFac.Direction = FacilityHierarchy.Direction
where   [FacilityHierarchy].Direction = 'downstream'
and [FacilityHierarchy].depth = 1
and [FacilityHierarchy].ConnectionType = 'water')
-----------------------------------------
,CompressFac as (
select [FacilityHierarchy].RootFloc
,Floc as CompressFac
FROM [OpsTech_DB].[HIERARCHY].[FacilityHierarchy]
inner join MinFac on MinFac.RootFloc = FacilityHierarchy.RootFloc
				and	minfac.Depth = FacilityHierarchy.Depth
				and MinFac.MinDistance = FacilityHierarchy.Distance
				and MinFac.ConnectionType = FacilityHierarchy.ConnectionType
				and MinFac.Direction = FacilityHierarchy.Direction
where   [FacilityHierarchy].Direction = 'upstream'
and [FacilityHierarchy].depth = 1
and [FacilityHierarchy].ConnectionType = 'gas'
and FacilityHierarchy.RootType = 'well')
-----------------------------------------
,InjFac as (
select [FacilityHierarchy].RootFloc
,Floc as InjFac
FROM [OpsTech_DB].[HIERARCHY].[FacilityHierarchy]
inner join MinFac on MinFac.RootFloc = FacilityHierarchy.RootFloc
				and	minfac.Depth = FacilityHierarchy.Depth
				and MinFac.MinDistance = FacilityHierarchy.Distance
				and MinFac.ConnectionType = FacilityHierarchy.ConnectionType
				and MinFac.Direction = FacilityHierarchy.Direction
where   [FacilityHierarchy].Direction = 'upstream'
and [FacilityHierarchy].depth = 1
and [FacilityHierarchy].ConnectionType = 'water'
and FacilityHierarchy.RootType = 'well')
-----------------------------------------exceptions---------------------------
,NoLvl1Oil as (
select RootFloc.RootFloc
,'No oil facility, ' as exception
FROM RootFloc
left join Oil_Fac_Lvl1 on RootFloc.RootFloc = Oil_Fac_Lvl1.RootFloc  
where  Oil_Fac_Lvl1.Oil_Facility is null
and RootFloc.Tech_Object_Type = 'FCLTY'
)
-----------------------------------------
,NoLvl1Gas as (
select RootFloc.RootFloc
,'No gas facility, ' as exception
FROM RootFloc
left join Gas_Fac_Lvl1 on RootFloc.RootFloc = Gas_Fac_Lvl1.RootFloc  
where  Gas_Fac_Lvl1.Gas_Facility is null
and RootFloc.Tech_Object_Type = 'FCLTY'
)
-----------------------------------------
,NoLvl1Water as (
select RootFloc.RootFloc
,'No water facility, ' as exception
FROM RootFloc
left join Water_Fac_Lvl1 on RootFloc.RootFloc = Water_Fac_Lvl1.RootFloc 
where  Water_Fac_Lvl1.Water_Facility is null
and RootFloc.Tech_Object_Type = 'FCLTY'
)
-----------------------------------------
,NoCompress as (
select RootFloc.RootFloc
,' Gas lift well with no compression station,' as exception
,RootFloc.Api_No10
FROM RootFloc
left join [OXY#redacted].[MDM#redacted].well on RootFloc.Api_No10 = well.Api_No10  
left join CompressFac on RootFloc.RootFloc = CompressFac.RootFloc
where CompressFac.CompressFac is null and
 (well.Primary_Completion_Mop = 'GAS_LIFT' or well.Primary_Completion_Type = 'inj_wag'))
-----------------------------------------
,NoInjFac as (
select RootFloc.RootFloc
,' Water injection well with no injection facility,' as exception
,RootFloc.Api_No10
FROM RootFloc
left join [OXY#redacted].[MDM#redacted].well on RootFloc.Api_No10 = well.Api_No10 
left join InjFac on RootFloc.RootFloc = InjFac.RootFloc
where InjFac.InjFac is null and
 ( well.Primary_Completion_Type in ('inj_wag','inj_H20')))
-----------------------------------------
,BigDistance as (select distinct RootFloc,
' Connection over 50 miles,' as exception
from [OpsTech_DB].[HIERARCHY].[FacilityHierarchy]
where Depth = 1
and Distance > 50
)
-----------------------------------------
,MutilSat as (SELECT [RootFloc]
      ,[ConnectionType]
      ,count([Floc]) as FacCount
  FROM [OpsTech_DB].[HIERARCHY].[FacilityHierarchy]
  where depth = 1
  and Direction = 'downstream'
  and RootType = 'well'
  group by RootFloc, ConnectionType
  having COUNT(floc) > 1)
,DistMultiSat as (select distinct RootFloc,
' Multiple satellites,' as exception
from MutilSat)
-----------------------------------------
,MatchSAP as (select distinct rootfloc.RootFloc, ConnectionType, 1 as SAPmatch
  from RootFloc
  inner join [OpsTech_DB].[HIERARCHY].[FacilityHierarchy] on [FacilityHierarchy].RootFloc = RootFloc.RootFloc
  inner join [OXY#redacted].[OPS#redacted].[Functional_Location_Class_Characteristics] FLCC on
		FLCC.Functional_Location = FacilityHierarchy.RootFloc
where (ConnectionType = 'oil' and Depth = 1  and FLCC.Oil_Facility_Id = [FacilityHierarchy].Floc)
or (ConnectionType = 'water' and Depth = 1  and FLCC.Water_Facility_Id = [FacilityHierarchy].Floc)
or (ConnectionType = 'gas' and Depth = 1   and FLCC.Gas_Facility_Id = [FacilityHierarchy].Floc)
) 
,NoMatchSAP as (select Functional_Location as RootFloc
,' No SAP Match' as exception
from [OXY#redacted].[OPS#redacted].[Functional_Location_Class_Characteristics] FLCC
left join MatchSAP on FLCC.Functional_Location = MatchSAP.RootFloc
where (MatchSAP.RootFloc is null and FLCC.Oil_Facility_Id is not null and FLCC.Oil_Facility_Id not like '% - %')
or (MatchSAP.RootFloc is null and FLCC.Water_Facility_Id is not null and FLCC.Water_Facility_Id not like '% - %')
or (MatchSAP.RootFloc is null and FLCC.Gas_Facility_Id is not null and FLCC.Gas_Facility_Id not like '% - %')
)
-----------------------------------------
,multiStop as (
select [Completion].Stop_Name
,', multiple stops per oil facility' as exception
,count(Oil_Fac_Lvl1.Oil_Facility) OilFacCount
,RootFloc.RootFloc
from RootFloc
inner join Oil_Fac_Lvl1 on RootFloc.RootFloc = Oil_Fac_Lvl1.RootFloc
left join [OXY#redacted].[MDM#redacted].[Completion] on RootFloc.Api_No10 = Completion.Api_No10
where RootFloc.RootFloc not like 'dj%'
and Completion.Current_Completion_Status = 'active'
group by [Completion].Stop_Name, RootFloc.RootFloc
having count(Oil_Fac_Lvl1.Oil_Facility) > 1
)
-----------------------------------------
,oilAllocation as (
select  distinct RootFloc.RootFloc
,', well allocated oil without satellite' as exception
 from [OXY#redacted].[MDM#redacted].[Completion_Connect_Xref] ccx
 inner join  RootFloc on SUBSTRING( ccx.Api_No14,1,10) = RootFloc.Api_No10
 left join  Oil_Fac_Lvl1 on RootFloc.RootFloc = Oil_Fac_Lvl1.RootFloc 
 where 
 Oil_Facility is null
 and connection_end_date = '2999-01-01 00:00:00.000'
 and Gathering_System_Name like '%oil%'
 and Connection_Type = 2
 )
-----------------------------------------
select RootFloc.RootFloc
,RootFloc.Tech_Object_Type
,RootFloc.Api_No10
, Oil_Facility
, Gas_Facility
, Water_Facility
, CompressFac
, InjFac
,ltrim(CONCAT(NoLvl1Oil.exception,NoLvl1Water.exception,NoLvl1Gas.exception, NoCompress.exception,NoInjFac.exception,BigDistance.exception,DistMultiSat.exception,NoMatchSAP.exception,multiStop.exception, oilAllocation.exception)) Exception

from RootFloc
left join Oil_Fac_Lvl1 on RootFloc.RootFloc = Oil_Fac_Lvl1.RootFloc
left join Gas_Fac_Lvl1 on RootFloc.RootFloc = Gas_Fac_Lvl1.RootFloc
left join Water_Fac_Lvl1 on RootFloc.RootFloc = Water_Fac_Lvl1.RootFloc
left join CompressFac on RootFloc.RootFloc = CompressFac.RootFloc
left join InjFac on RootFloc.RootFloc = InjFac.RootFloc
left join NoLvl1Oil on RootFloc.RootFloc = NoLvl1Oil.RootFloc
left join NoLvl1Water on RootFloc.RootFloc = NoLvl1Water.RootFloc
left join NoLvl1Gas on RootFloc.RootFloc = NoLvl1Gas.RootFloc
left join NoCompress on RootFloc.RootFloc = NoCompress.RootFloc
left join NoInjFac on RootFloc.RootFloc = NoInjFac.RootFloc
left join BigDistance on RootFloc.RootFloc = BigDistance.RootFloc
left join DistMultiSat on RootFloc.RootFloc = DistMultiSat.RootFloc
left join NoMatchSAP on RootFloc.RootFloc = NoMatchSAP.RootFloc
left join multiStop on RootFloc.RootFloc = multiStop.RootFloc
left join oilAllocation on RootFloc.RootFloc = oilAllocation.RootFloc
--where    multiStop.exception is not null
;
GO



